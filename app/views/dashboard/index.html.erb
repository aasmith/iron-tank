<% @stylesheets = %W(dashboard) %>


<div id="change-warning" class="info box">
  You have edited a transaction. 
  <%= link_to "Reload the page" %> to see your updated spending by category.
</div>

<div id="main">
  <div class="category box">
    <div class="chart"><div id="gg" class="plot"></div></div>
    <div class="spend">$832</div>
    <div class="diff over">$132</div>
    <div class="title">Insurance</div>
    <div class="break"></div>
    <div class="expanded">
      <hr />
      <p>Average line: <a href="">Change to a goal amount</a></p>
      <hr />
      <table>
        <tr>
          <td>$832</td><td>from Checking</td><td>Tuesday, 4<sup>th</sup></td>
        </tr>
        <tr>
          <td>$832</td><td>from Checking</td><td>Tuesday, 4<sup>th</sup></td>
        </tr>
        <tr>
          <td>$832</td><td>from Checking</td><td>Tuesday, 4<sup>th</sup></td>
        </tr>
      </table>
    </div>
  </div>

  <%= render :partial => "expenses" %>

  <h3>Recent Transactions</h3>
  <% @daily_entries.each do |date, entries| %>
    <div class="transaction box">
      <div class="amount">
        <%= net_gain(entries).format %>
      </div>
      <div class="date">
        <%= @period == :weekly ? "Week of" : "" %>
        <%= pretty_date(date, @current_days >= 30) %>
      </div>
      <div class="categories">
        <%= h summarize_ledgers(entries.map(&:remote_ledgers)) %>
      </div>
      <div class="break"></div>
      <div class="expanded">
        <hr/>
        <table>
          <% entries.each do |entry| %>
            <%= render :partial => "entry", :object => entry %>
            <%= render :partial => "entry_edit", :locals => {:entry => entry} %>
          <% end %>
        </table>
      </div>
    </div>
  <% end %>

</div>

<div id="side">
  <div class="action box">
    <p><a href="http://someplace">Approve</a> 3 new transactions</p>
    <p><a href="http://someplace">Categorize</a> 9 transactions</p>
  </div>

  <div class="date-range box">
    <p>Showing data for</p>
    <p>Last
      <% @days.each do |d| %>
        <% if @current_days == d %>
          <strong><%= d %></strong>
        <% else %>
          <%= link_to d, {:days => d} %>
        <% end %>
      <% end %>
      days
    </p>
  </div>

  <div class="delta box">
    <h2 class="over">$4,032</h2>
    <div class="plot" id="hh">dd</div>
    <table><tbody>
      <tr><td>Earned</td><td>$4,530</td></tr>
      <tr><td>Spent</td><td>$8,562</td></tr>
    </tbody></table>
  </div>
</div>


<script id="source" language="javascript" type="text/javascript">
$(function () {
    var origin = 0;
    var avg = 638.5; // target line
    var spend = [[0, 138.05], [1,127.05], [2,137], [3,138.05], [4,127.05], [5,137], [6,842.56], [7,0], [8,0], [9,0], [10,0], [11,842.56]];

    var options = {
      shadowSize: 0,
      grid: { borderWidth: 0 },
      yaxis: {ticks: []},
      xaxis: {ticks: []}
    };
    options['colors'] = jQuery.map(spend, function(e) { return e[1] == 0 ? '#f2f2f2' : (e[1] > avg ? '#BF0C00' : '#7DB700') } );
    options['colors'].push('#2383C7'); // avg line color

    var plotArray = jQuery.map(spend, function(e) { return {data: [e], bars: { show: true, barWidth: 0.8 }} } );
    plotArray.push({data: [[0, avg],[spend.length, avg]], lines: { show: true, lineWidth: 0.5 } });

    jQuery.plot($("#gg"), plotArray, options);

    $(window).resize(function(){
      jQuery.plot($("#gg"), plotArray, options);
    });
});

$(function () {
    var deltas = [[0, 1010], [1,893], [2,1434], [3,1204], [4,-200], [5,800], [6,-389], [7,297], [8,-581], [9,-904], [10,102], [11,-783]].reverse();
    var origin = 0; // draw this as an actual line and it makes the graph slightly wider, so the border doesnt intrude.

    var options = {
      shadowSize: 0,
      grid: { borderWidth: 0 },
      yaxis: {ticks: []},
      xaxis: {ticks: []}
    };
    options['colors'] = jQuery.map(deltas, function(e) { return e[1] == 0 ? 'transparent' : (e[1] < 0 ? '#BF0C00' : '#7DB700') } );
    options['colors'].push('black'); // origin color

    var plotArray = jQuery.map(deltas, function(e) { return {data: [e], bars: { align: 'center', show: true, barWidth: 0.8 }} } );
    plotArray.push({data: [[0, origin],[deltas.length, origin]], lines: { show: true, lineWidth: 0.5 } });

    jQuery.plot($("#hh"), plotArray, options);

    $(window).resize(function(){
      jQuery.plot($("#hh"), plotArray, options);
    });

});

$(["transaction", "category"]).each(function(idx, className) {
  $("."+className+":not(.remaining) div:not(.expanded)").
    css({cursor:'pointer'});

  $("."+className+" div:not(.expanded)").click(
    function(){
      var h = $("~ .expanded:hidden", this);
      var v = $("~ .expanded:visible", this);
      h.size() == 1 ? 
        h.animate({height:"show"}, 250, "easeInOutExpo") :
        v.animate({height:"hide"}, 250, "easeInOutExpo") ;
    }
  )
});


function initLedgerSelectors() {
  $(".entry-edit").hide();
  $(".entry sup a").css({visibility:'hidden'});

  $(".entry .editable").hover(
    function(){$("a.change", this).css({visibility:'visible'})},
    function(){$("a.change", this).css({visibility:'hidden'})}
  );
  
  $(".entry .editable").click(function(){
    $(this).parents(".entry").hide();
    $(this).parents(".entry").next().fadeIn(100);
    return false;
  });
  
  $(".entry .editable").css({cursor:'pointer'});
  
  $(".entry-edit input[type=reset]").click(function(){
    $(this).parents(".entry-edit").hide();
    $(this).parents(".entry-edit").prev().fadeIn(100);
  });
  
}

$(function(){ initLedgerSelectors(); });

</script>
